<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andy - Assistente Pessoal v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e1e2f 0%, #121212 100%);
            --accent: #00d2ff;
            --text: #ffffff;
        }

        /* Temas Dinâmicos */
        body.perfil-tarcio { --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); --accent: #00d2ff; }
        body.perfil-andressa { --bg-gradient: linear-gradient(135deg, #2d1b33 0%, #4a2c5a 100%); --accent: #a29bfe; }
        body.triste { --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); --accent: #4a90e2; }
        body.feliz { --bg-gradient: linear-gradient(135deg, #1d4350 0%, #f48fb1 100%); --accent: #ff4081; }
        body.sos { --bg-gradient: linear-gradient(135deg, #870000 0%, #190a05 100%); --accent: #ff0000; }
        body.foco { --bg-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); --accent: #555555; }

        body {
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: var(--bg-gradient); color: var(--text);
            font-family: 'Montserrat', sans-serif; transition: all 0.8s ease; overflow: hidden;
        }

        #user-display { position: absolute; top: 20px; font-weight: 600; letter-spacing: 2px; opacity: 0.7; }
        #response-box { width: 85%; max-width: 600px; text-align: center; font-size: 1.2rem; min-height: 80px; line-height: 1.5; }

        .mic-btn {
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); border: 2px solid var(--accent);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s; box-shadow: 0 0 20px var(--accent); margin: 20px;
        }

        .mic-btn.listening { animation: pulse 1.5s infinite; background: var(--accent); }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 var(--accent); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(0,0,0,0); }
            100% { transform: scale(1); }
        }

        #loader { display: none; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body id="body">

    <div id="user-display">INICIALIZANDO...</div>
    <div id="response-box">Aguardando comando...</div>
    
    <button class="mic-btn" id="btn">
        <svg fill="white" height="30" viewBox="0 0 24 24" width="30"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
    </button>

    <div id="loader"></div>

<script src="https://unpkg.com/@google/generative-ai@0.1.0/dist/index.js"></script>

<script>
    // 2. A biblioteca clássica coloca tudo dentro de 'googleGenerativeAi'
    const { GoogleGenerativeAI } = window.googleGenerativeAi;

    // --- CONFIGURAÇÃO ---
    const API_KEY = "AIzaSyBXQAJ_yiKf7rRrX1yBTpV4JAnqKR9kcJU"; 
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    let usuarioAtivo = localStorage.getItem('usuarioAtivo') || "Tárcio";
    let voices = [];

    const meusContatos = {
        "andressa": "5593992066978",
        "tárcio": "5593981054823"
    };

    const responseBox = document.getElementById('response-box');
    const userDisplay = document.getElementById('user-display');
    const loader = document.getElementById('loader');
    const body = document.body;

    // --- SÍNTESE DE VOZ ---
    const initVoices = () => { voices = window.speechSynthesis.getVoices(); };
    window.speechSynthesis.onvoiceschanged = initVoices;
    initVoices();

    function speak(text, pitch = 1.1, rate = 1.05) {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = voices.find(v => v.lang.includes('pt-BR')) || voices[0];
        utter.pitch = pitch;
        utter.rate = rate;
        window.speechSynthesis.speak(utter);
    }

    function darSaudacao() {
        userDisplay.innerText = `PERFIL: ${usuarioAtivo.toUpperCase()}`;
        body.className = usuarioAtivo === "Tárcio" ? "perfil-tarcio" : "perfil-andressa";
        const hora = new Date().getHours();
        let saudacao = (hora < 12) ? "Bom dia" : (hora < 18) ? "Boa tarde" : "Boa noite";
        let msg = usuarioAtivo === "Tárcio" ? `${saudacao}, meu criador.` : `${saudacao}, Andressa. Como posso ajudar?`;
        responseBox.innerText = msg;
        speak(msg, usuarioAtivo === "Andressa" ? 1.3 : 1.1);
    }

    // --- RECONHECIMENTO DE VOZ ---
    const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
    recognition.lang = 'pt-BR';

    document.getElementById('btn').onclick = () => {
        try { recognition.start(); } catch(e) { console.log("Já ouvindo..."); }
    };

    recognition.onstart = () => { document.getElementById('btn').classList.add('listening'); };
    recognition.onend = () => { document.getElementById('btn').classList.remove('listening'); };

    recognition.onresult = async (event) => {
        const userText = event.results[0][0].transcript.toLowerCase();
        loader.style.display = "block";
        responseBox.innerText = "...";

        // Comandos de Perfil
        if (userText.includes("aqui é o tárcio")) {
            usuarioAtivo = "Tárcio"; localStorage.setItem('usuarioAtivo', "Tárcio");
            darSaudacao(); loader.style.display = "none"; return;
        }
        if (userText.includes("aqui é a andressa")) {
            usuarioAtivo = "Andressa"; localStorage.setItem('usuarioAtivo', "Andressa");
            darSaudacao(); loader.style.display = "none"; return;
        }

        // Busca Direta ou IA
        try {
            const mKey = `memoria_${usuarioAtivo}`;
            const prompt = `Você é a Andy. Usuário: ${usuarioAtivo}. Responda com clareza e use [FELIZ] ou [TRISTE] no fim. Frase: "${userText}"`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            let text = response.text();

            let p = 1.1;
            if (text.includes("[TRISTE]")) { body.className = "triste"; p = 0.8; }
            else if (text.includes("[FELIZ]")) { body.className = "feliz"; p = 1.3; }

            text = text.replace(/\[.*?\]/g, "").trim();
            responseBox.innerText = text;
            speak(text, usuarioAtivo === "Andressa" ? p + 0.2 : p);
        } catch (e) {
            console.error(e);
            responseBox.innerText = "Erro: Verifique sua Chave API ou conexão.";
        } finally {
            loader.style.display = "none";
        }
    };

    window.onload = darSaudacao;
</script>
