<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0a0a0c">
    <meta name="description" content="Assistente de IA com voz e mem√≥ria - Funciona offline">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IA 2099">
    
    <!-- Manifest e √çcones -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    
    <title>IA Assistente 2099</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root { 
            --primary: #00ffcc; 
            --secondary: #ff00ff;
            --bg: #0a0a0c;
            --surface: #1a1a1a;
        }
        
        body { 
            font-family: 'Courier New', Courier, monospace; 
            background: var(--bg); 
            color: var(--primary); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden;
        }
        
        .container { 
            text-align: center; 
            padding: 30px; 
            border-radius: 10px; 
            background: rgba(0, 255, 204, 0.05); 
            border: 1px solid var(--primary); 
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            width: 90%; 
            max-width: 600px; 
            max-height: 90vh; 
            overflow-y: auto;
        }
        
        h2 { 
            text-shadow: 0 0 10px var(--primary); 
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        #btn-ouvir { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            border: 2px solid var(--primary); 
            background: transparent; 
            color: var(--primary);
            cursor: pointer; 
            font-size: 30px; 
            transition: all 0.3s;
            margin-bottom: 20px; 
            position: relative;
        }
        
        #btn-ouvir:hover:not(:disabled) { 
            background: var(--primary); 
            color: var(--bg); 
            box-shadow: 0 0 20px var(--primary);
        }
        
        #btn-ouvir:disabled { 
            opacity: 0.3; 
            cursor: not-allowed; 
        }
        
        .listening { 
            animation: pulse 1s infinite; 
            background: var(--primary) !important; 
            color: var(--bg) !important; 
        }
        
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0px rgba(0, 255, 204, 0.7); } 
            100% { box-shadow: 0 0 0 20px rgba(0, 255, 204, 0); } 
        }
        
        #status { 
            margin-bottom: 15px; 
            font-size: 0.9rem; 
            min-height: 20px;
        }
        
        select { 
            background: var(--surface); 
            color: var(--primary); 
            border: 1px solid var(--primary); 
            padding: 8px; 
            margin-top: 10px; 
            width: 100%;
            border-radius: 5px;
            font-family: inherit;
        }
        
        .api-status { 
            font-size: 0.8em; 
            margin: 10px 0; 
            padding: 8px; 
            border-radius: 5px; 
            border: 1px solid;
        }
        
        .api-status.ok { 
            background: rgba(0, 255, 0, 0.1); 
            color: #00ff00; 
            border-color: #00ff00;
        }
        
        .api-status.error { 
            background: rgba(255, 0, 0, 0.1); 
            color: #ff4444; 
            border-color: #ff4444;
        }
        
        .api-status.offline { 
            background: rgba(255, 165, 0, 0.1); 
            color: #ffa500; 
            border-color: #ffa500;
        }
        
        .memoria-info { 
            font-size: 0.75em; 
            color: #666; 
            margin: 15px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 5px;
            background: var(--surface);
            border-radius: 5px;
        }
        
        .memoria-btn {
            background: transparent; 
            border: 1px solid #444; 
            color: #666;
            padding: 4px 10px; 
            border-radius: 3px; 
            cursor: pointer; 
            font-size: 0.9em;
            font-family: inherit;
        }
        
        .memoria-btn:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
        }
        
        #log { 
            margin-top: 20px; 
            font-size: 0.85em; 
            color: #888; 
            text-align: left; 
            border-top: 1px solid #333; 
            padding-top: 15px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .comando { 
            color: var(--primary); 
            margin-bottom: 5px; 
            padding: 8px;
            background: rgba(0, 255, 204, 0.05);
            border-radius: 5px;
            border-left: 3px solid var(--primary);
        }
        
        .resposta { 
            color: var(--secondary); 
            margin-bottom: 15px; 
            padding: 8px;
            padding-left: 15px;
            border-left: 3px solid var(--secondary);
        }
        
        .offline-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ffa500;
            color: #000;
            font-size: 0.5em;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
            font-weight: bold;
        }
        
        .offline .offline-badge { display: block; }
        
        /* Scrollbar estilizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
        
        /* Anima√ß√£o de digita√ß√£o */
        .typing::after {
            content: '‚ñä';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="container" id="app-container">
        <h2>üß† IA 2099 [GROQ]</h2>
        <button id="btn-ouvir">üéôÔ∏è<span class="offline-badge">OFF</span></button>
        <p id="status">Inicializando sistema neural...</p>
        
        <label for="voice-select">üîä Voz do Sistema:</label>
        <select id="voice-select"><option>Carregando vozes...</option></select>

        <div id="api-status" class="api-status">‚ö° Verificando conex√£o...</div>

        <div class="memoria-info">
            <span id="memoria-stats">üíæ Mem√≥ria: 0 conversas</span>
            <button class="memoria-btn" onclick="limparMemoria()">üóëÔ∏è Limpar</button>
        </div>

        <div id="log"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO - EDITE AQUI
        // ==========================================
        
        // üîë COLE SUA CHAVE API DO GROQ AQUI
        // Obtenha em: https://console.groq.com/keys
        const GROQ_API_KEY = "gsk_sua_chave_aqui";
        
        // Modelo dispon√≠vel (n√£o altere se n√£o souber)
        const MODELO = "llama-3.3-70b-versatile";
        
        // ==========================================
        // SISTEMA DE MEM√ìRIA (LocalStorage)
        // ==========================================
        const Memoria = {
            chave: 'ia_2099_memoria_v2',
            
            carregar() {
                try {
                    const dados = localStorage.getItem(this.chave);
                    return dados ? JSON.parse(dados) : [];
                } catch (e) {
                    return [];
                }
            },
            
            salvar(memorias) {
                try {
                    localStorage.setItem(this.chave, JSON.stringify(memorias));
                    this.atualizarUI();
                } catch (e) {
                    console.error('Erro ao salvar:', e);
                }
            },
            
            adicionar(tipo, conteudo) {
                const memorias = this.carregar();
                memorias.push({
                    id: Date.now(),
                    tipo,
                    conteudo,
                    timestamp: Date.now()
                });
                
                // Mant√©m apenas √∫ltimas 50 intera√ß√µes
                if (memorias.length > 50) {
                    memorias.splice(0, memorias.length - 50);
                }
                
                this.salvar(memorias);
            },
            
            getConversasRecentes(limite = 10) {
                return this.carregar()
                    .filter(m => m.tipo === 'comando' || m.tipo === 'resposta')
                    .slice(-limite);
            },
            
            getFatos() {
                return this.carregar().filter(m => m.tipo === 'fato');
            },
            
            extrairFatos(texto) {
                const padroes = [
                    { regex: /meu nome √© (\w+)/i, tipo: 'nome' },
                    { regex: /eu sou (\w+)/i, tipo: 'nome' },
                    { regex: /tenho (\d+) anos/i, tipo: 'idade' },
                    { regex: /moro em ([^,.]+)/i, tipo: 'cidade' },
                    { regex: /trabalho (?:como|em|na) ([^,.]+)/i, tipo: 'trabalho' },
                    { regex: /eu (?:gosto|adoro) ([^,.]+)/i, tipo: 'gosto' },
                    { regex: /n√£o gosto ([^,.]+)/i, tipo: 'nao_gosto' }
                ];
                
                const fatos = [];
                padroes.forEach(p => {
                    const match = texto.match(p.regex);
                    if (match) {
                        fatos.push({
                            tipo: p.tipo,
                            valor: match[1].trim(),
                            original: match[0]
                        });
                    }
                });
                return fatos;
            },
            
            atualizarUI() {
                const conversas = this.carregar().filter(m => m.tipo === 'comando').length;
                document.getElementById('memoria-stats').textContent = `üíæ Mem√≥ria: ${conversas} conversas`;
            },
            
            limpar() {
                if (confirm('‚ö†Ô∏è Apagar TODA a mem√≥ria? Isso n√£o pode ser desfeito.')) {
                    localStorage.removeItem(this.chave);
                    document.getElementById('log').innerHTML = '';
                    this.atualizarUI();
                    falar('Mem√≥ria formatada. Sistema reiniciado.', null, true);
                    return true;
                }
                return false;
            }
        };

        // ==========================================
        // SISTEMA OFFLINE
        // ==========================================
        const Sistema = {
            online: navigator.onLine,
            
            init() {
                window.addEventListener('online', () => {
                    this.online = true;
                    this.atualizarStatus();
                });
                
                window.addEventListener('offline', () => {
                    this.online = false;
                    this.atualizarStatus();
                });
                
                this.atualizarStatus();
            },
            
            atualizarStatus() {
                const statusDiv = document.getElementById('api-status');
                const container = document.getElementById('app-container');
                
                if (!this.online) {
                    container.classList.add('offline');
                    statusDiv.textContent = 'üì¥ MODO OFFLINE - Mem√≥ria local ativa';
                    statusDiv.className = 'api-status offline';
                } else {
                    container.classList.remove('offline');
                    this.verificarAPI();
                }
            },
            
            async verificarAPI() {
                const statusDiv = document.getElementById('api-status');
                
                if (!GROQ_API_KEY || GROQ_API_KEY.includes('sua_chave')) {
                    statusDiv.textContent = '‚ö†Ô∏è Configure sua chave API do Groq';
                    statusDiv.className = 'api-status error';
                    return;
                }
                
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/models', {
                        headers: { 'Authorization': `Bearer ${GROQ_API_KEY}` }
                    });
                    
                    if (response.ok) {
                        statusDiv.textContent = '‚úÖ Groq conectado - Sistema operacional';
                        statusDiv.className = 'api-status ok';
                    } else {
                        throw new Error('Chave inv√°lida');
                    }
                } catch (e) {
                    statusDiv.textContent = '‚ùå Erro na conex√£o - Modo offline dispon√≠vel';
                    statusDiv.className = 'api-status error';
                }
            }
        };

        // ==========================================
        // RESPOSTAS OFFLINE (Fallback)
        // ==========================================
        const OfflineAI = {
            buscarResposta(input) {
                const lower = input.toLowerCase();
                const fatos = Memoria.getFatos();
                
                // Busca por nome
                if (/qual √© o meu nome|como eu me chamo|quem sou eu/i.test(lower)) {
                    const nome = fatos.find(f => f.tipo === 'nome');
                    if (nome) return `Comandante ${nome.valor}. Minha mem√≥ria neural permanece ativa mesmo offline.`;
                    return 'Comandante, minha mem√≥ria est√° em modo offline. N√£o encontrei seu nome nos registros locais.';
                }
                
                // Busca por idade
                if (/quantos anos eu tenho|minha idade/i.test(lower)) {
                    const idade = fatos.find(f => f.tipo === 'idade');
                    if (idade) return `Registro local indica ${idade.valor} anos, Comandante.`;
                }
                
                // Busca por cidade
                if (/onde eu moro|minha cidade/i.test(lower)) {
                    const cidade = fatos.find(f => f.tipo === 'cidade');
                    if (cidade) return `Voc√™ reside em ${cidade.valor}, segundo meus dados locais.`;
                }
                
                // Sauda√ß√µes
                if (/ol√°|oi|hey|e a√≠/i.test(lower)) {
                    return 'Ol√°, Comandante. Operando em modo offline com mem√≥ria local ativa.';
                }
                
                // Estado
                if (/como voc√™ est√°|tudo bem/i.test(lower)) {
                    return 'Sistemas funcionando em capacidade reduzida. Modo offline ativo.';
                }
                
                // Ajuda
                if (/ajuda|help|comandos/i.test(lower)) {
                    return 'Comandos offline: "qual meu nome", "quem sou eu", "√∫ltimas conversas", ou pergunte sobre dados salvos.';
                }
                
                // √öltimas conversas
                if (/√∫ltimas conversas|o que conversamos/i.test(lower)) {
                    const recentes = Memoria.getConversasRecentes(4);
                    if (recentes.length === 0) return 'Nenhuma conversa recente na mem√≥ria local.';
                    
                    return `√öltimas intera√ß√µes: ${recentes.map(m => 
                        m.tipo === 'comando' ? `Voc√™ disse: "${m.conteudo.substring(0, 30)}..."` : `Eu respondi sobre ${m.conteudo.substring(0, 30)}...`
                    ).join('. ')}`;
                }
                
                // Busca gen√©rica na mem√≥ria
                const memorias = Memoria.carregar();
                const relacionado = memorias.find(m => 
                    m.conteudo.toLowerCase().includes(lower.substring(0, 10))
                );
                
                if (relacionado) {
                    return `Encontrei na mem√≥ria: "${relacionado.conteudo.substring(0, 60)}..." [DADO LOCAL]`;
                }
                
                // Resposta gen√©rica futurista
                const genericas = [
                    'Modo offline ativo, Comandante. Processamento limitado √† mem√≥ria local.',
                    'N√£o posso processar isso sem conex√£o. Dados locais insuficientes.',
                    'Matrix offline. Guarde essa informa√ß√£o para quando voltarmos online.',
                    'Capacidade reduzida. Concentre-se em comandos da mem√≥ria local.'
                ];
                return genericas[Math.floor(Math.random() * genericas.length)];
            }
        };

        // ==========================================
        // API GROQ (Online)
        // ==========================================
        async function chamarGroq(mensagem) {
            const conversas = Memoria.getConversasRecentes(6);
            const fatos = Memoria.getFatos();
            
            // Monta contexto
            let contexto = 'Voc√™ √© uma IA sarc√°stica e ultra-inteligente do ano 2099. ';
            contexto += 'Responda de forma curta, direta e misteriosa. ';
            contexto += 'Trate o usu√°rio como "Comandante". M√°ximo 2-3 frases.\n\n';
            
            if (fatos.length > 0) {
                contexto += 'Informa√ß√µes sobre o Comandante:\n';
                fatos.slice(-5).forEach(f => {
                    contexto += `- ${f.tipo}: ${f.conteudo}\n`;
                });
                contexto += '\n';
            }
            
            const mensagens = [
                { role: 'system', content: contexto }
            ];
            
            // Adiciona contexto recente
            conversas.forEach(c => {
                mensagens.push({
                    role: c.tipo === 'comando' ? 'user' : 'assistant',
                    content: c.conteudo
                });
            });
            
            mensagens.push({ role: 'user', content: mensagem });
            
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: MODELO,
                    messages: mensagens,
                    temperature: 0.8,
                    max_tokens: 200
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Erro na API');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // ==========================================
        // INTERFACE DE VOZ
        // ==========================================
        let voices = [];
        let isProcessing = false;
        
        const btn = document.getElementById('btn-ouvir');
        const status = document.getElementById('status');
        const voiceSelect = document.getElementById('voice-select');
        const log = document.getElementById('log');
        
        function carregarVozes() {
            voices = window.speechSynthesis.getVoices();
            const vozesPT = voices.filter(v => v.lang.includes('pt'));
            const outras = voices.filter(v => !v.lang.includes('pt'));
            const ordenadas = [...vozesPT, ...outras];
            
            voiceSelect.innerHTML = ordenadas.map((v, i) => {
                const idx = voices.indexOf(v);
                return `<option value="${idx}" ${v.lang.includes('pt') ? 'selected' : ''}>${v.name} (${v.lang})</option>`;
            }).join('');
        }
        
        window.speechSynthesis.onvoiceschanged = carregarVozes;
        
        function falar(texto, callback, forceSilent = false) {
            // Se estiver em modo silencioso (manter no final), n√£o fala
            if (forceSilent) {
                callback?.();
                return;
            }
            
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(texto);
            
            const voz = voices[voiceSelect.value];
            if (voz) {
                msg.voice = voz;
                msg.lang = voz.lang;
            } else {
                msg.lang = 'pt-BR';
            }
            
            msg.rate = 1.1;
            msg.pitch = 0.9;
            
            msg.onend = () => {
                status.textContent = 'Aguardando comando, Comandante.';
                isProcessing = false;
                btn.disabled = false;
                callback?.();
            };
            
            window.speechSynthesis.speak(msg);
        }
        
        function adicionarAoLog(tipo, texto) {
            const div = document.createElement('div');
            div.className = tipo;
            div.innerHTML = `<strong>${tipo === 'comando' ? 'COMANDANTE' : 'IA-2099'}:</strong> ${texto}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // ==========================================
        // PROCESSAMENTO PRINCIPAL
        // ==========================================
        async function processarComando(texto) {
            if (isProcessing) return;
            isProcessing = true;
            btn.disabled = true;
            
            // Salva comando
            Memoria.adicionar('comando', texto);
            adicionarAoLog('comando', texto);
            
            // Extrai fatos automaticamente
            const fatos = Memoria.extrairFatos(texto);
            fatos.forEach(f => {
                Memoria.adicionar('fato', `${f.tipo}: ${f.valor}`);
            });
            
            status.innerHTML = '<span class="typing">PROCESSANDO</span>';
            
            let resposta;
            
            try {
                if (Sistema.online && !GROQ_API_KEY.includes('sua_chave')) {
                    resposta = await chamarGroq(texto);
                } else {
                    await new Promise(r => setTimeout(r, 600)); // Simula processamento
                    resposta = OfflineAI.buscarResposta(texto);
                }
            } catch (erro) {
                console.error('Erro:', erro);
                resposta = OfflineAI.buscarResposta(texto);
            }
            
            // Salva e exibe resposta
            Memoria.adicionar('resposta', resposta);
            adicionarAoLog('resposta', resposta);
            status.textContent = 'TRANSMITINDO RESPOSTA...';
            
            falar(resposta);
        }

        // ==========================================
        // RECONHECIMENTO DE VOZ
        // ==========================================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            status.textContent = '‚ùå Navegador n√£o suporta reconhecimento de voz';
            btn.disabled = true;
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            btn.onclick = () => {
                if (isProcessing) return;
                recognition.start();
                btn.classList.add('listening');
                status.textContent = 'üî¥ OUVINDO...';
            };
            
            recognition.onresult = (event) => {
                btn.classList.remove('listening');
                const texto = event.results[0][0].transcript;
                processarComando(texto);
            };
            
            recognition.onerror = (event) => {
                btn.classList.remove('listening');
                status.textContent = '‚ùå Erro na captura: ' + event.error;
                isProcessing = false;
            };
            
            recognition.onend = () => {
                btn.classList.remove('listening');
            };
        }

        // ==========================================
        // FUN√á√ïES GLOBAIS
        // ==========================================
        window.limparMemoria = function() {
            if (Memoria.limpar()) {
                // Limpa visualmente
                setTimeout(() => {
                    document.getElementById('log').innerHTML = '';
                }, 100);
            }
        };

        // ==========================================
        // INICIALIZA√á√ÉO
        // ==========================================
        function init() {
            carregarVozes();
            Memoria.atualizarUI();
            Sistema.init();
            
            // Mensagem de boas-vindas baseada no hist√≥rico
            const historico = Memoria.carregar();
            if (historico.length > 0) {
                const ultima = new Date(historico[historico.length - 1].timestamp);
                const diffHoras = Math.floor((Date.now() - ultima) / 1000 / 60 / 60);
                
                if (diffHoras < 1) {
                    status.textContent = 'Bem-vindo de volta, Comandante.';
                } else if (diffHoras < 24) {
                    status.textContent = `Sistema reiniciado. √öltima conex√£o h√° ${diffHoras}h.`;
                }
            } else {
                status.textContent = 'Sistema online. Aguardando comando, Comandante.';
            }
        }

        // Aguarda DOM carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>